name: Checkmarx SCA Scan (Windows)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  sca-scan:
    name: CxSCA Scan using Resolver (Windows)
    runs-on: windows-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Download and unzip CxSCA Resolver (Windows)
        run: |
          curl -L -o ScaResolver.zip https://sca-downloads.s3.amazonaws.com/cli/latest/ScaResolver-win64.zip
          tar -xf ScaResolver.zip || powershell -Command "Expand-Archive -Path ScaResolver.zip -DestinationPath ."

      - name: Run CxSCA Scan (Windows)
        run: |
          .\ScaResolver.exe `
            --client-id "${{ secrets.CX_CLIENT_ID }}" `
            --client-secret "${{ secrets.CX_CLIENT_SECRET }}" `
            --tenant "${{ secrets.CX_TENANT }}" `
            --base-uri "${{ secrets.CX_BASE_URI }}" `
            --project-name "${{ secrets.CX_PROJECT_NAME }}" `
            --scan-types sca `
            --include-sources .
